#!/bin/bash

# update distribution
apt-get update
apt-get install -y 

# install packages
apt -y install apache2 mysql-server php php-mysqli php-gd libapache2-mod-php git

# clone DVWA repo
cd ~
git clone --recursive https://github.com/ethicalhack3r/DVWA.git

# clean up apache2 destination
rm /var/www/html/index.html
cp -r ~/DVWA/* /var/www/html/
cd /var/www/html
chown -R www-data.www-data /var/www/html/
cp config/config.inc.php.dist config/config.inc.php

# allow RFI 
sed -i 's/^allow_url_include.*$/allow_url_include = On/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^;allow_url_include.*$/allow_url_include = On/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^allow_url_fopen.*$/allow_url_fopen = On/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^;allow_url_fopen.*$/allow_url_fopen = On/g' /etc/php/7.2/apache2/php.ini

# allow SQLi
sed -i 's/^safe_mode.*$/safe_mode = Off/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^;safe_mode.*$/safe_mode = Off/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^magic_quotes_gpc.*$/magic_quotes_gpc = Off/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^;magic_quotes_gpc.*$/magic_quotes_gpc = Off/g' /etc/php/7.2/apache2/php.ini

# hide PHP warning
sed -i 's/^display_errors.*$/display_errors = Off/g' /etc/php/7.2/apache2/php.ini
sed -i 's/^;display_errors.*$/display_errors = Off/g' /etc/php/7.2/apache2/php.ini

# change permissions 
chmod 757 /var/www/html/hackable/uploads/
chmod 646 /var/www/html/external/phpids/0.6/lib/IDS/tmp/phpids_log.txt 
chmod 757 /var/www/html/config

# restart services
systemctl restart apache2
systemctl restart mysql

# create DB
mysqladmin -u root password p@ssw0rd
mysql -u root -pp@ssw0rd -e "use mysql; create database dvwa; create user dvwa@localhost identified by 'p@ssw0rd'; grant all on dvwa.* to dvwa@localhost; flush privileges;"
